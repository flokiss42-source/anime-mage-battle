<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Anime Mage Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            border: 2px solid #9d4edd;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .battle-area {
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border: 3px solid #ff6b6b;
            position: relative;
            min-height: 300px;
        }
        
        .character {
            position: absolute;
            width: 100px;
            height: 150px;
            bottom: 30px;
            transition: all 0.3s;
        }
        
        .player {
            left: 100px;
        }
        
        .enemy {
            right: 100px;
            transform: scaleX(-1);
        }
        
        .health-bar {
            width: 200px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px auto;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .player-health {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }
        
        .enemy-health {
            background: linear-gradient(90deg, #f44336, #ff9800);
        }
        
        .skills {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .skill-btn {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            border: none;
            color: white;
            padding: 20px 10px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .skill-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(106, 17, 203, 0.5);
        }
        
        .skill-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .skill-cost {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .battle-log {
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid;
            background: rgba(255,255,255,0.1);
        }
        
        .damage-log {
            border-color: #ff6b6b;
        }
        
        .heal-log {
            border-color: #4CAF50;
        }
        
        .info-log {
            border-color: #2196F3;
        }
        
        .rank-system {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
        }
        
        .rank {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
        }
        
        .rank.active {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid gold;
        }
        
        .rank-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .xp-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bcd4, #0097a7);
            border-radius: 5px;
        }
        
        .upgrade-shop {
            display: none;
            background: rgba(0,0,0,0.8);
            padding: 25px;
            border-radius: 20px;
            margin-top: 20px;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 3px solid #9d4edd;
        }
        
        button {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 25px rgba(255, 107, 107, 0.5);
        }
        
        .character-img {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ú® ANIME MAGE BATTLE ‚ú®</h1>
            <div class="player-stats">
                <div class="stat-card">
                    <div>‚ö° –£—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat-card">
                    <div>üèÜ –†–∞–Ω–≥</div>
                    <div class="stat-value" id="rank">–ù–æ–≤–∏—á–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div>üí∞ –û—á–∫–∏</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-card">
                    <div>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</div>
                    <div class="stat-value" id="health">100</div>
                </div>
                <div class="stat-card">
                    <div>üîÆ –ú–∞–Ω–∞</div>
                    <div class="stat-value" id="mana">100</div>
                </div>
                <div class="stat-card">
                    <div>‚≠êÔ∏è –û–ø—ã—Ç</div>
                    <div class="stat-value" id="xp">0/100</div>
                </div>
            </div>
            
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
            </div>
        </header>
        
        <div class="rank-system">
            <div class="rank" id="rank1">
                <div class="rank-icon">ü•â</div>
                <div>–ù–æ–≤–∏—á–æ–∫</div>
            </div>
            <div class="rank" id="rank2">
                <div class="rank-icon">ü•à</div>
                <div>–ú–∞–≥</div>
            </div>
            <div class="rank" id="rank3">
                <div class="rank-icon">ü•á</div>
                <div>–ê—Ä—Ö–∏–º–∞–≥</div>
            </div>
            <div class="rank" id="rank4">
                <div class="rank-icon">üëë</div>
                <div>–ú–∞—Å—Ç–µ—Ä –°—Ç–∏—Ö–∏–π</div>
            </div>
            <div class="rank" id="rank5">
                <div class="rank-icon">üíé</div>
                <div>–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ú–∞–≥</div>
            </div>
        </div>
        
        <div class="battle-area">
            <div class="health-bar">
                <div class="health-fill player-health" id="playerHealth" style="width: 100%"></div>
            </div>
            
            <div class="character player">
                <div class="character-img" id="playerChar">‚öîÔ∏è</div>
            </div>
            
            <div class="character enemy">
                <div class="character-img" id="enemyChar">üëπ</div>
            </div>
            
            <div class="health-bar">
                <div class="health-fill enemy-health" id="enemyHealth" style="width: 100%"></div>
            </div>
            
            <div id="enemyName" style="text-align: center; margin-top: 10px; font-weight: bold;">–ì–æ–±–ª–∏–Ω –£—Ä–æ–≤–µ–Ω—å 1</div>
        </div>
        
        <div class="skills">
            <button class="skill-btn" onclick="useSkill(0)">
                <span>üî• –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä</span>
                <span class="skill-cost">üîÆ 20</span>
            </button>
            <button class="skill-btn" onclick="useSkill(1)">
                <span>‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è —Å—Ç—Ä–µ–ª–∞</span>
                <span class="skill-cost">üîÆ 15</span>
            </button>
            <button class="skill-btn" onclick="useSkill(2)">
                <span>‚ö° –ú–æ–ª–Ω–∏—è</span>
                <span class="skill-cost">üîÆ 25</span>
            </button>
            <button class="skill-btn" onclick="useSkill(3)">
                <span>üíö –ò—Å—Ü–µ–ª–µ–Ω–∏–µ</span>
                <span class="skill-cost">üîÆ 30</span>
            </button>
            <button class="skill-btn" onclick="useSkill(4)">
                <span>üõ°Ô∏è –©–∏—Ç</span>
                <span class="skill-cost">üîÆ 40</span>
            </button>
            <button class="skill-btn" onclick="useSkill(5)">
                <span>üåÄ –í–∏—Ö—Ä—å</span>
                <span class="skill-cost">üîÆ 35</span>
            </button>
            <button class="skill-btn" onclick="useSkill(6)">
                <span>üí• –ú–µ—Ç–µ–æ—Ä</span>
                <span class="skill-cost">üîÆ 50</span>
            </button>
            <button class="skill-btn" onclick="useSkill(7)">
                <span>‚ú® –°–≤—è—Ç–∞—è –∞—Ç–∞–∫–∞</span>
                <span class="skill-cost">üîÆ 45</span>
            </button>
        </div>
        
        <div class="battle-log" id="battleLog"></div>
        
        <div style="text-align: center; margin: 25px 0;">
            <button onclick="startBattle()">‚öîÔ∏è –ù–ê–ß–ê–¢–¨ –ë–ò–¢–í–£</button>
            <button onclick="openShop()">üè™ –ú–ê–ì–ê–ó–ò–ù</button>
            <button onclick="saveGame()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        
        <div class="upgrade-shop" id="shop">
            <h3 style="text-align: center; margin-bottom: 20px;">üè™ –ú–ê–ì–ê–ó–ò–ù –£–õ–£–ß–®–ï–ù–ò–ô</h3>
            <div class="upgrade-item">
                <div>üî• –°–∏–ª–∞ –æ–≥–Ω—è (+10% —É—Ä–æ–Ω–∞)</div>
                <button onclick="buyUpgrade('fire')" data-cost="100">üí∞ 100</button>
            </div>
            <div class="upgrade-item">
                <div>‚ùÑÔ∏è –°–∏–ª–∞ –ª—å–¥–∞ (+15% –∫ —à–∞–Ω—Å—É –∑–∞–º–æ—Ä–æ–∑–∫–∏)</div>
                <button onclick="buyUpgrade('ice')" data-cost="150">üí∞ 150</button>
            </div>
            <div class="upgrade-item">
                <div>‚ù§Ô∏è –ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ (+50 HP)</div>
                <button onclick="buyUpgrade('health')" data-cost="200">üí∞ 200</button>
            </div>
            <div class="upgrade-item">
                <div>üîÆ –ú–∞–∫—Å. –º–∞–Ω–∞ (+50 MP)</div>
                <button onclick="buyUpgrade('mana')" data-cost="200">üí∞ 200</button>
            </div>
            <div class="upgrade-item">
                <div>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞–Ω—ã</div>
                <button onclick="buyUpgrade('regen')" data-cost="300">üí∞ 300</button>
            </div>
            <button onclick="closeShop()" style="margin-top: 20px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω</button>
        </div>
    </div>
    
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 style="color: #ff6b6b; margin-bottom: 20px;">üíÄ –ë–ò–¢–í–ê –ü–†–û–ò–ì–†–ê–ù–ê</h2>
            <p id="resultText">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ –±–∏—Ç–≤—É!</p>
            <p style="margin: 15px 0;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞: <span id="xpEarned">0</span></p>
            <button onclick="restartBattle()">üîÑ –ù–æ–≤–∞—è –±–∏—Ç–≤–∞</button>
            <button onclick="sendResult()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        </div>
    </div>
    
    <div class="modal" id="winModal">
        <div class="modal-content">
            <h2 style="color: #4CAF50; margin-bottom: 20px;">üèÜ –ë–ò–¢–í–ê –í–´–ò–ì–†–ê–ù–ê!</h2>
            <p id="winText">–í—ã –ø–æ–±–µ–¥–∏–ª–∏ –≤—Ä–∞–≥–∞!</p>
            <p style="margin: 15px 0;">–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞: <span id="xpWin">0</span></p>
            <p style="margin: 15px 0;">–ü–æ–ª—É—á–µ–Ω–æ –æ—á–∫–æ–≤: <span id="scoreWin">0</span></p>
            <button onclick="nextBattle()">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤—Ä–∞–≥</button>
            <button onclick="sendResult()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        </div>
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        
        // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        let gameState = {
            level: 1,
            rank: "–ù–æ–≤–∏—á–æ–∫",
            score: 0,
            health: 100,
            maxHealth: 100,
            mana: 100,
            maxMana: 100,
            xp: 0,
            xpNeeded: 100,
            enemyHealth: 100,
            enemyMaxHealth: 100,
            enemyLevel: 1,
            enemyType: "goblin",
            battleActive: false,
            upgrades: {
                fire: 0,
                ice: 0,
                health: 0,
                mana: 0,
                regen: 0
            },
            skills: [
                { name: "–û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä", cost: 20, damage: 25, element: "fire" },
                { name: "–õ–µ–¥—è–Ω–∞—è —Å—Ç—Ä–µ–ª–∞", cost: 15, damage: 20, element: "ice", freezeChance: 0.2 },
                { name: "–ú–æ–ª–Ω–∏—è", cost: 25, damage: 35, element: "lightning" },
                { name: "–ò—Å—Ü–µ–ª–µ–Ω–∏–µ", cost: 30, heal: 40, element: "holy" },
                { name: "–©–∏—Ç", cost: 40, defense: 0.5, element: "earth" },
                { name: "–í–∏—Ö—Ä—å", cost: 35, damage: 30, element: "wind" },
                { name: "–ú–µ—Ç–µ–æ—Ä", cost: 50, damage: 60, element: "fire" },
                { name: "–°–≤—è—Ç–∞—è –∞—Ç–∞–∫–∞", cost: 45, damage: 55, element: "holy" }
            ],
            enemies: [
                { name: "–ì–æ–±–ª–∏–Ω", health: 100, damage: 10, xp: 50, emoji: "üëπ" },
                { name: "–û—Ä–∫", health: 150, damage: 15, xp: 75, emoji: "üë∫" },
                { name: "–î—Ä–∞–∫–æ–Ω", health: 300, damage: 25, xp: 150, emoji: "üêâ" },
                { name: "–î–µ–º–æ–Ω", health: 250, damage: 30, xp: 200, emoji: "üòà" },
                { name: "–¢–µ–º–Ω—ã–π –º–∞–≥", health: 200, damage: 35, xp: 180, emoji: "üßô‚Äç‚ôÇÔ∏è" }
            ]
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            updateUI();
            updateRanks();
            loadGame();
            addLog("‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Anime Mage Battle!", "info");
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('rank').textContent = gameState.rank;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('mana').textContent = gameState.mana;
            document.getElementById('xp').textContent = `${gameState.xp}/${gameState.xpNeeded}`;
            
            // –®–∫–∞–ª—ã –∑–¥–æ—Ä–æ–≤—å—è
            const playerHealthPercent = (gameState.health / gameState.maxHealth) * 100;
            const enemyHealthPercent = (gameState.enemyHealth / gameState.enemyMaxHealth) * 100;
            
            document.getElementById('playerHealth').style.width = playerHealthPercent + '%';
            document.getElementById('enemyHealth').style.width = enemyHealthPercent + '%';
            
            // –®–∫–∞–ª–∞ –æ–ø—ã—Ç–∞
            const xpPercent = (gameState.xp / gameState.xpNeeded) * 100;
            document.getElementById('xpFill').style.width = xpPercent + '%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–∞–≥–∞
            const enemy = gameState.enemies[gameState.enemyType === "goblin" ? 0 : 
                          gameState.enemyType === "ork" ? 1 : 
                          gameState.enemyType === "dragon" ? 2 :
                          gameState.enemyType === "demon" ? 3 : 4];
            
            document.getElementById('enemyName').textContent = 
                `${enemy.name} –£—Ä–æ–≤–µ–Ω—å ${gameState.enemyLevel}`;
            document.getElementById('enemyChar').textContent = enemy.emoji;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∫–∏–ª–ª–æ–≤
            updateSkills();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–Ω–≥–æ–≤
        function updateRanks() {
            const ranks = ["–ù–æ–≤–∏—á–æ–∫", "–ú–∞–≥", "–ê—Ä—Ö–∏–º–∞–≥", "–ú–∞—Å—Ç–µ—Ä –°—Ç–∏—Ö–∏–π", "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ú–∞–≥"];
            const currentRankIndex = ranks.indexOf(gameState.rank);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelectorAll('.rank').forEach(rank => {
                rank.classList.remove('active');
            });
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥
            if (currentRankIndex >= 0) {
                document.getElementById(`rank${currentRankIndex + 1}`).classList.add('active');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∫–∏–ª–ª–æ–≤
        function updateSkills() {
            const skillButtons = document.querySelectorAll('.skill-btn');
            skillButtons.forEach((btn, index) => {
                const skill = gameState.skills[index];
                if (gameState.mana < skill.cost || !gameState.battleActive) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫–∏–ª–ª–∞
        function useSkill(skillIndex) {
            if (!gameState.battleActive) {
                addLog("–ë–∏—Ç–≤–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞!", "info");
                return;
            }
            
            const skill = gameState.skills[skillIndex];
            
            if (gameState.mana < skill.cost) {
                addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞–Ω—ã!", "info");
                return;
            }
            
            // –¢—Ä–∞—Ç–∏–º –º–∞–Ω—É
            gameState.mana -= skill.cost;
            
            // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å–∫–∏–ª–ª–∞
            let damage = skill.damage || 0;
            let heal = skill.heal || 0;
            let message = "";
            
            // –ë–æ–Ω—É—Å—ã –æ—Ç —É–ª—É—á—à–µ–Ω–∏–π
            if (skill.element === "fire") {
                damage += damage * (gameState.upgrades.fire * 0.1);
            }
            if (skill.element === "ice" && skill.freezeChance) {
                if (Math.random() < (skill.freezeChance + gameState.upgrades.ice * 0.15)) {
                    message = " –í—Ä–∞–≥ –∑–∞–º–æ—Ä–æ–∂–µ–Ω!";
                }
            }
            
            // –ù–∞–Ω–æ—Å–∏–º —É—Ä–æ–Ω –∏–ª–∏ –ª–µ—á–∏–º
            if (damage > 0) {
                gameState.enemyHealth -= damage;
                addLog(`‚öîÔ∏è ${skill.name} –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞${message}`, "damage");
            }
            if (heal > 0) {
                gameState.health = Math.min(gameState.maxHealth, gameState.health + heal);
                addLog(`üíö ${skill.name} –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ${heal} HP`, "heal");
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
            if (gameState.enemyHealth <= 0) {
                gameState.enemyHealth = 0;
                winBattle();
            } else {
                // –•–æ–¥ –≤—Ä–∞–≥–∞
                setTimeout(enemyAttack, 1000);
            }
            
            updateUI();
        }
        
        // –ê—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞
        function enemyAttack() {
            if (!gameState.battleActive) return;
            
            const enemy = gameState.enemies[gameState.enemyType === "goblin" ? 0 : 
                          gameState.enemyType === "ork" ? 1 : 
                          gameState.enemyType === "dragon" ? 2 :
                          gameState.enemyType === "demon" ? 3 : 4];
            
            let damage = enemy.damage + Math.floor(Math.random() * 10);
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —â–∏—Ç–∞
            if (Math.random() < 0.3) { // 30% —à–∞–Ω—Å —á—Ç–æ —â–∏—Ç —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
                damage = Math.floor(damage * 0.5);
                addLog("üõ°Ô∏è –©–∏—Ç –ø–æ–≥–ª–æ—â–∞–µ—Ç —á–∞—Å—Ç—å —É—Ä–æ–Ω–∞!", "info");
            }
            
            gameState.health -= damage;
            addLog(`üëπ ${enemy.name} –∞—Ç–∞–∫—É–µ—Ç –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞`, "damage");
            
            // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–Ω—ã
            gameState.mana = Math.min(gameState.maxMana, gameState.mana + 5 + gameState.upgrades.regen * 2);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
            if (gameState.health <= 0) {
                gameState.health = 0;
                gameOver();
            }
            
            updateUI();
        }
        
        // –ù–∞—á–∞—Ç—å –±–∏—Ç–≤—É
        function startBattle() {
            gameState.battleActive = true;
            gameState.health = gameState.maxHealth;
            gameState.mana = gameState.maxMana;
            
            const enemyTypes = ["goblin", "ork", "dragon", "demon", "mage"];
            gameState.enemyType = enemyTypes[Math.min(gameState.level - 1, 4)];
            gameState.enemyLevel = Math.floor(gameState.level / 2) + 1;
            
            const enemyIndex = enemyTypes.indexOf(gameState.enemyType);
            const enemy = gameState.enemies[enemyIndex];
            gameState.enemyMaxHealth = enemy.health * gameState.enemyLevel;
            gameState.enemyHealth = gameState.enemyMaxHealth;
            
            addLog(`‚öîÔ∏è –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –±–∏—Ç–≤–∞ —Å ${enemy.name} —É—Ä–æ–≤–Ω—è ${gameState.enemyLevel}!`, "info");
            updateUI();
        }
        
        // –ü–æ–±–µ–¥–∞ –≤ –±–∏—Ç–≤–µ
        function winBattle() {
            gameState.battleActive = false;
            
            const enemyIndex = gameState.enemies.findIndex(e => 
                e.name.toLowerCase().includes(gameState.enemyType));
            const xpEarned = gameState.enemies[enemyIndex].xp * gameState.enemyLevel;
            const scoreEarned = 100 * gameState.enemyLevel;
            
            gameState.xp += xpEarned;
            gameState.score += scoreEarned;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å
            if (gameState.xp >= gameState.xpNeeded) {
                levelUp();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–Ω–≥
            checkRank();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ–±–µ–¥—ã
            document.getElementById('xpWin').textContent = xpEarned;
            document.getElementById('scoreWin').textContent = scoreEarned;
            document.getElementById('winText').textContent = 
                `–í—ã –ø–æ–±–µ–¥–∏–ª–∏ ${gameState.enemies[enemyIndex].name} —É—Ä–æ–≤–Ω—è ${gameState.enemyLevel}!`;
            document.getElementById('winModal').style.display = 'flex';
            
            updateUI();
        }
        
        // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ
        function gameOver() {
            gameState.battleActive = false;
            const xpEarned = Math.floor(gameState.xpNeeded * 0.1);
            gameState.xp += xpEarned;
            
            document.getElementById('xpEarned').textContent = xpEarned;
            document.getElementById('resultText').textContent = 
                `–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ –±–∏—Ç–≤—É —Å ${gameState.enemies.find(e => 
                    e.name.toLowerCase().includes(gameState.enemyType)).name}!`;
            document.getElementById('gameOverModal').style.display = 'flex';
            
            updateUI();
        }
        
        // –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
        function levelUp() {
            gameState.level++;
            gameState.xp -= gameState.xpNeeded;
            gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.5);
            
            gameState.maxHealth += 20;
            gameState.maxMana += 15;
            gameState.health = gameState.maxHealth;
            gameState.mana = gameState.maxMana;
            
            addLog(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã —É—Ä–æ–≤–Ω—è ${gameState.level}`, "info");
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–Ω–≥–∞
        function checkRank() {
            const ranks = [
                { level: 1, name: "–ù–æ–≤–∏—á–æ–∫" },
                { level: 5, name: "–ú–∞–≥" },
                { level: 10, name: "–ê—Ä—Ö–∏–º–∞–≥" },
                { level: 15, name: "–ú–∞—Å—Ç–µ—Ä –°—Ç–∏—Ö–∏–π" },
                { level: 20, name: "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ú–∞–≥" }
            ];
            
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (gameState.level >= ranks[i].level) {
                    if (gameState.rank !== ranks[i].name) {
                        gameState.rank = ranks[i].name;
                        addLog(`üèÜ –ù–æ–≤—ã–π —Ä–∞–Ω–≥: ${ranks[i].name}!`, "info");
                        updateRanks();
                    }
                    break;
                }
            }
        }
        
        // –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
        function openShop() {
            document.getElementById('shop').style.display = 'block';
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
        function closeShop() {
            document.getElementById('shop').style.display = 'none';
        }
        
        // –ö—É–ø–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ
        function buyUpgrade(type) {
            const button = event.target;
            const cost = parseInt(button.getAttribute('data-cost'));
            
            if (gameState.score < cost) {
                addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!", "info");
                return;
            }
            
            gameState.score -= cost;
            gameState.upgrades[type]++;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —É–ª—É—á—à–µ–Ω–∏–µ
            switch(type) {
                case 'health':
                    gameState.maxHealth += 50;
                    gameState.health = gameState.maxHealth;
                    break;
                case 'mana':
                    gameState.maxMana += 50;
                    gameState.mana = gameState.maxMana;
                    break;
            }
            
            addLog(`‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ "${type}" –∫—É–ø–ª–µ–Ω–æ!`, "info");
            updateUI();
        }
        
        // –ù–æ–≤–∞—è –±–∏—Ç–≤–∞ (–ø–æ—Å–ª–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è)
        function restartBattle() {
            document.getElementById('gameOverModal').style.display = 'none';
            startBattle();
        }
        
        // –°–ª–µ–¥—É—é—â–∏–π –≤—Ä–∞–≥ (–ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã)
        function nextBattle() {
            document.getElementById('winModal').style.display = 'none';
            startBattle();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É
        function saveGame() {
            const saveData = {
                level: gameState.level,
                score: gameState.score,
                xp: gameState.xp,
                xpNeeded: gameState.xpNeeded,
                rank: gameState.rank,
                upgrades: gameState.upgrades,
                maxHealth: gameState.maxHealth,
                maxMana: gameState.maxMana
            };
            
            localStorage.setItem('animeMageSave', JSON.stringify(saveData));
            addLog("üíæ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!", "info");
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É
        function loadGame() {
            const saved = localStorage.getItem('animeMageSave');
            if (saved) {
                const saveData = JSON.parse(saved);
                Object.assign(gameState, saveData);
                gameState.health = gameState.maxHealth;
                gameState.mana = gameState.maxMana;
                addLog("üíæ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!", "info");
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
        function sendResult() {
            const gameData = {
                type: "anime_mage_battle",
                level: gameState.level,
                rank: gameState.rank,
                score: gameState.score,
                xp: gameState.xp,
                upgrades: gameState.upgrades
            };
            
            if (tg && tg.sendData) {
                tg.sendData(JSON.stringify(gameData));
                setTimeout(() => {
                    if (tg.close) tg.close();
                }, 2000);
            } else {
                alert("–†–µ–∑—É–ª—å—Ç–∞—Ç: " + JSON.stringify(gameData, null, 2));
            }
            
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('winModal').style.display = 'none';
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
        function addLog(message, type) {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}-log`;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(saveGame, 30000);
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = initGame;
    </script>
</body>
</html>
